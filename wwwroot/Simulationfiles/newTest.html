<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Device Simulator</title>
  </head>
  <body>
    <h2>Device Simulator</h2>
    <button onclick="connectDevice()">Connect Device</button>
    <pre id="log"></pre>

    <script>
      const logEl = document.getElementById("log");
      function log(msg) {
        logEl.textContent += msg + "\n";
      }

      let ws;
      let deviceId = "SIM_DEVICE_001";

      // Example file list
      let files = [
        { id: "1", name: "log1.bin", size: 12345 },
        { id: "2", name: "cfg.json", size: 987 },
        { id: "3", name: "report.txt", size: 21485760 },
      ];

      function connectDevice() {
        ws = new WebSocket(`ws://localhost:5010/ws/${deviceId}`);
        ws.binaryType = "arraybuffer";

        ws.onopen = () => {
          log("Connected to server.");
          ws.send(
            JSON.stringify({
              type: "STATUS",
              deviceId: deviceId,
              uptime: "1h 23m",
              heap: "512KB",
              wifi_rssi: "-55dBm",
              wifi_ip: "192.168.1.50",
              connected: true,
            })
          );
          log("Sent STATUS");
        };

        ws.onmessage = async (event) => {
          if (typeof event.data === "string") {
            const msg = JSON.parse(event.data);
            log("Received: " + JSON.stringify(msg));

            switch (msg.type) {
              case "STATUS":
                ws.send(
                  JSON.stringify({
                    type: "STATUS",
                    deviceId: deviceId,
                    uptime: "1h 23m",
                    heap: "512KB",
                    wifi_rssi: "-55dBm",
                    wifi_ip: "192.168.1.50",
                    connected: true,
                  })
                );
                log("Sent STATUS");
                break;

              case "LIST_FILES":
                // return raw array
                ws.send(JSON.stringify(files));
                log("Sent file list");
                break;

              case "REQUEST_FILE":
                const file = files.find((f) => f.name === msg.filename);
                if (!file) {
                  ws.send(
                    JSON.stringify({
                      type: "ERROR",
                      message: "File not found",
                    })
                  );
                  return;
                }
                // Send FILE_START
                ws.send(
                  JSON.stringify({
                    type: "FILE_START",
                    filename: file.name,
                    size: file.size,
                  })
                );
                log(`Sent FILE_START for ${file.name}`);

                // Split file into chunks and send
                const chunkSize = 16384;
                let remaining = file.size;
                let index = 0;
                while (remaining > 0) {
                  let sizeHere = Math.min(remaining, chunkSize);
                  let buffer = new Uint8Array(4 + sizeHere);
                  buffer[0] = (index >> 24) & 0xff;
                  buffer[1] = (index >> 16) & 0xff;
                  buffer[2] = (index >> 8) & 0xff;
                  buffer[3] = index & 0xff;
                  for (let i = 0; i < sizeHere; i++)
                    buffer[i + 4] = Math.floor(Math.random() * 256);
                  ws.send(buffer);
                  log(`Sent chunk ${index} (${sizeHere} bytes)`);
                  remaining -= sizeHere;
                  index++;
                  await new Promise((r) => setTimeout(r, 5));
                }

                ws.send(JSON.stringify({ type: "FILE_END" }));
                ws.send(new ArrayBuffer(0));
                log(`Sent FILE_END for ${file.name}`);
                break;

              case "DELETE_FILE":
                const delFile = files.find((f) => f.name === msg.filename);
                if (delFile) {
                  files = files.filter((f) => f.name !== msg.filename);
                  ws.send(
                    JSON.stringify({
                      type: "success",
                      message: `${msg.filename} deleted`,
                    })
                  );
                  log(`Deleted file: ${msg.filename}`);
                } else {
                  ws.send(
                    JSON.stringify({
                      type: "ERROR",
                      message: "File not found",
                    })
                  );
                }
                break;

              case "DELETE_ALL_FILES":
                files = [];
                ws.send(
                  JSON.stringify({
                    type: "success",
                    message: "All files deleted",
                  })
                );
                log("Deleted all files");
                break;
              case "DISCONNECT":
                ws.send(
                  JSON.stringify({
                    type: "success",
                    message: "Disconnecting ...",
                  })
                );
                log("Sent Success: ");
                log("web socket closed disconnecting: ");
                ws.close();
            }
          } else if (event.data instanceof ArrayBuffer) {
            log(`Received binary frame (${event.data.byteLength} bytes)`);
          }
        };

        ws.onclose = () => log("WebSocket closed.");
        ws.onerror = (err) => log("WebSocket error: " + err.message);
      }
    </script>
  </body>
</html>
